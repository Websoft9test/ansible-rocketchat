# install OpenCV by OS_family
- name: Install this role on {{ansible_os_family}}
  include: "{{ansible_os_family}}.yml"

# prepare installation
- name: rm -rf /data/wwwroot/rocketchat for second installation
  shell: rm -rf /data/wwwroot/rocketchat

- name: Using npm install inherits and node
  shell: npm install -g inherits n && sudo n 12.14.0

# install rocketchat    
- name: Download rocketchat
  unarchive:
    src: "{{rocketchat_download_url}}"
    dest: /data/wwwroot
    remote_src: yes

- name:  Install rocketchat
  shell: 
  args:
    cmd: npm install
    chdir: /data/wwwroot/bundle/programs/server

- name: Rename dir name
  shell: cd /data/wwwroot; if [ ! -d "rocketchat" ]; then mv bundle rocketchat; fi   

- name: Creat rocketchat_user & set permiss
  shell: |
    useradd -M rocketchat && sudo usermod -L rocketchat
    chown -R rocketchat:rocketchat /data/wwwroot/rocketchat

# configure MongoDB
- name: Configure MongoDB
  shell: | 
    sed -i "s/^#replication:/replication:\n  replSetName: rs01/" /etc/mongod.conf

- name: Start & Enable mongod.service
  service: 
    name: mongod 
    state: restarted

- name: Use mongo shell initiate 
  shell: mongo --eval "printjson(rs.initiate())"

# configure the Rocket.Chat service
- name: Copy rocketchat.service file
  template:
    src: rocketchat.service.j2
    dest: '/lib/systemd/system/rocketchat.service'
    
- name: Start & Enable rocketchat.service
  service: 
    name: rocketchat 
    state: started
    enabled: yes

 # Check version,
 # must use sudo sh -c to solve the no-root permission
- block:
  - name: Check rocketchat Version
    shell:  sudo sh -c "echo 'no method for rocketchat version' 1>> /data/logs/install_version.txt" 

# check service state
- name: Check rocketchat Service
  shell: systemctl status rocketchat | grep Active*
  register: check_rocketchat_service
  notify: check_rocketchat_service
